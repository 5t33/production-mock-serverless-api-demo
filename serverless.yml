
service: lambda-api-demo
plugins:
  - serverless-offline
  
provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage}
  region: us-east-2
  tracing:
    lambda: true
    apiGateway: true
    
functions:
  DemoLambda:
    role: DemoLambdaRole
    handler: index.handler
    integration: lambda
    events:
      - http:
          path: /health_check
          method: get
          integration: lambda  
      - http:
          path: /respond_400
          method: post
          integration: lambda  
          response:
            statusCodes:
              400:
                pattern: '.*"statusCode":400,.*' # JSON response
                template: $input.path("$.errorMessage") # JSON return object
      - http:
          path: /throw_error
          method: get
          integration: lambda  
          response:
            statusCodes:
              500:
                pattern: '.*"statusCode":500,.*' # JSON response
                template: $input.path("$.errorMessage") # JSON return object

resources:
  Resources:
    DemoLambdaRole:
      Type: AWS::IAM::Role
      Properties:
        Path: /${opt:stage}/demos/lambdaApiDemo/serviceRoles/
        RoleName: DemoLambdaRole
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: 
                  - lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: DemoLambdaPolicy2
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - 'Fn::Join':
                      - ':'
                      -
                        - 'arn:aws:logs'
                        - Ref: 'AWS::Region'
                        - Ref: 'AWS::AccountId'
                        - 'log-group:/aws/lambda/*:*:*'
                - Effect: Allow
                  Action:
                    - xray:PutTraceSegment
                    - xray:PutTraceSegments
                    - xray:PutTelemetryRecords
                  Resource: "*"